<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="space">
    <meta name="keywords" content="space">
    <title>全部航天器一览</title>
    <link rel="stylesheet" type="text/css" href="/static/home/css/reset.css">
    <link rel="stylesheet" href="/static/home/css/global.css">
    <link rel="stylesheet" href="/static/home/css/main.css">
    <!--[if IE 8]>
    <link rel="stylesheet" href="/static/home/css/font.css">
    <![endif]-->
    <style type="text/css" media="screen">
        body, html {
            margin: 0;
            padding: 0;
            position: relative;
            font-size: 100%;
        }

        body {
            min-width: 1200px;
            background: #00294d url(/static/home/images/banner_1.png) no-repeat;
            background-position: center 0;
        }

        .content .filterBox.w200 .filterList {
            padding-right: 5px !important;
        }

        .mySelectType40165 .select2-container .select2-selection--single .select2-selection__clear {
            position: relative;
            left: -20px;
            top: -1px !important;
        }

        .gray {
            -webkit-filter: grayscale(100%);
            -moz-filter: grayscale(100%);
            -ms-filter: grayscale(100%);
            -o-filter: grayscale(100%);
            filter: grayscale(100%);
            filter: gray;
        }
    </style>


    <link href="/static/home/compontents/datatable/datatables.min.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/static/home/css/datatable.css">

    <link href="/static/home/compontents/select2/dist/css/select2.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/static/home/css/myselect2.css">

    <script lanuage='javascript'>
    	//debugger;
			self.moveTo(0,0);
			self.resizeTo(screen.availWidth,screen.availHeight);
		</script>

</head>


<body>
<div class="header wrapper">
    <input type="hidden" id="userimg" value="{{userimgpath}}"/>
    <img src="/static/home/images/logo.png" alt="" class="logo">
    <ul class="nav">
        <li class="navItem">
            <a href="/tval" target="_blank" class="leaderboard"></a>
        </li>
        <li class="navItem">
            <a href="/tval/rank" target="_blank" class="analysis"></a>
        </li>
        <li class="navItem">
            <a href="/tval/analysis/satCPx" target="_blank" class="displaywall"></a>
        </li>
        <li class="navItem last">
            <a href="#" class="indicatordisplay active"></a>
        </li>
    </ul>
    <div class="user">
        <img src="/static/userimages/foreground.png" class="usericon-wapper">
        <img src="{{userimgpath}}" class="usericon">
        <ul class="dropdownBox">
            <li class="userInfo">
                <span class="db font24">{{userInfo.name}}</span>
                <span class="db font14">当前登录者</span>
            </li>
            <li class="dropdownList js_modify"><a class="color33">修改密码</a></li>
            <li class="dropdownList"><a class="colorR" href="javascript:" onclick="logout()">退出</a></li>
        </ul>
    </div>
</div>
<div class="content wrapper marT10">
    <div class="serachBox clearfix" style="margin-bottom: 10px;text-align: left;">
        <input class="fl inputBox" id="keywords" placeholder="请输入搜索关键字"/>
        <span class="fl searchBtn" id="searchBtn"></span>
    </div>
    <div class="optionalRangeBox" style="margin-top: 10px">
        <div class="rangeTitle" style="padding: 30px">
            <!--div id="chart_wrapper" style="float: left">
         <span class="db font30">全部航天器一览</span>
     </div-->
            <div style="float: right">
                <ul class="clearfix filterBox w200" style="margin-top: 0px;margin-bottom: 0px;margin-right:18px">
                    <li class="filterList" style="padding-right: 10px">
                    <span class="input-group-btn">
                        <a id="show_image" class="trbselect current">图形显示</a>
                    </span>
                    </li>
                    <li class="filterList" style="padding-right: 0px">
                    <span class="input-group-btn">
                        <a id="show_table" class="trbselect">表格显示</a>
                    </span>
                    </li>
                </ul>
            </div>
            <span class="db font30" style="padding-left:14px">航天器一览:<span id="craftnum"></span>颗</span>
        </div>


        <div>

            <ul class="clearfix filterBox w200" style="margin-bottom: 0px;margin-left:40px">
                <li class="filterList">
                    <span class="db font18">筛选条件</span>
                </li>
                <li class="filterList mySelectType40165">
                    <select class="condition" id="factory" style="width: 165px">
                    </select>
                </li>
                <li class="filterList mySelectType40165">
                    <select class="condition" style="width: 165px" id="field">
                    </select>
                </li>
                <li class="filterList mySelectType40165">
                    <select class="condition" style="width: 165px" id="test_commander">
                    </select>
                </li>
                <li class="filterList mySelectType40165">
                    <select class="condition" id="commander" style="width: 165px">
                    </select>
                </li>
                <li class="filterList mySelectType40165">
                    <select class="condition" style="width: 165px" id="designer">
                    </select>
                </li>
                <li class="filterList mySelectType40165" style="padding-right: 0px !important;">
                    <select class="condition" style="width: 165px; " id="testYear">
                    </select>
                </li>

            </ul>

            <ul class="clearfix filterBox w200" style="margin-bottom: 0px;margin-left:40px">
                <li class="filterList">
                    <span class="db font18"><div style="width: 72px"></div></span>
                </li>
                <li class="filterList mySelectType40165">

                    <select class="condition" style="width: 165px" id="orbitType">
                    </select>
                </li>
                <li class="filterList mySelectType40165">
                    <select class="condition" id="applyField" style="width: 165px">
                    </select>
                </li>

                <li class="filterList mySelectType40165">
                    <select class="condition" style="width: 165px" id="powerstyle">
                    </select>
                </li>
                <li class="filterList mySelectType40165">
                    <select class="condition" id="size" style="width: 165px">
                    </select>
                </li>
                <li class="filterList mySelectType40165">
                    <select class="condition" style="width: 165px" id="platform">
                    </select>
                </li>
                <li class="filterList mySelectType40165" style="padding-right: 0px !important;">
                    <select class="condition" style="width: 165px; " id="produce_stage">
                    </select>
                </li>


            </ul>


        </div>

        <div>
            <ul class="yearBox" id="satlist" style="">
            </ul>

            <div id="sattable" style="display:none">
                <div class="indicatorAnalysisFilterBox line" style="padding-bottom: 10px;margin-bottom: 13px">
                </div>

                <div class="divtable five">
                    <table id="example" cellspacing="0" width="100%">
                        <thead>
                        <tr style="width: 100%">
                            <th class="nameIcon wrapper-1">航天器代号</th>
                            <th class="markIcon wrapper-2">航天器名称</th>
                            <th class="numIcon wrapper-3">总指挥/总师/测试指挥</th>
                            <th class="scoreIcon wrapper-4">加电时间</th>
                            <th class="clickIcon wrapper-5">操作</th>
                        </tr>
                        </thead>
                    </table>
                </div>

            </div>

        </div>


    </div>
</div>

<div class="pop_bg"></div>
<div class="modify-password-box">
    <form class="modify-form" id="changpwd">
        <span class="form-title">修改密码</span>
        <div class="form-group">
            <input class="form-input" type="password" autocomplete="off" placeholder="请输入新密码" id="new_p" name="new_p"
                   value="">
        </div>
        <div class="form-group">
            <input class="form-input" type="password" autocomplete="off" placeholder="请再次确认新密码" id="new_p2"
                   name="new_p2" value="">
        </div>
        <div class="form-actions">
            <a href="javascript:;" class="form-btn" onclick="chpassword()">确认修改</a>
        </div>
    </form>
</div>

<div class="footer">
    © CASC 2018
</div>

<script src="/static/home/compontents/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="/static/home/compontents/datatable/datatables.min.js"></script>
<script type="text/javascript" src="/static/home/compontents/select2/dist/js/select2.js"></script>
<script type="text/javascript" src="/static/home/js/placeholderSupport.js"></script>
<script type="text/javascript" src="/static/home/js/mylogin.js"></script>
<script type="text/javascript" src="/static/home/js/util.js"></script>
<script>
  var SatArray = [];
  var ResultSatArr = [];


  function parseISO8601(dateStringInRange) {
    var isoExp = /^\s*(\d{4})-(\d\d)-(\d\d)\s*$/,
        date = new Date(NaN), month,
        parts = isoExp.exec(dateStringInRange);

    if (parts) {
      month = +parts[2];
      date.setFullYear(parts[1], month - 1, parts[3]);
      if (month != date.getMonth() + 1) {
        date.setTime(NaN);
      }
    }
    return date;
  }

  var querysats = function () {
    var cond = {};
    var conddom = $(".condition");
    for (var i = 0; i < conddom.length; i++) {
      var domitem = conddom[i];
      if (domitem.value !== '') {
        cond[domitem.id] = domitem.value;
      }
    }
    //console.log(cond);
    var tmpArr = selectArr(SatArray, cond);

    var keyword = $('#keywords').val();
    ResultSatArr = selectArrByReg(tmpArr, ['name', 'code', 'code_out'], keyword);

    ResultSatArr.sort(function (x, y) {
      //var x_launch = parseISO8601(x.lanuchTime.substr(0, 10));testDate
      //var y_launch = parseISO8601(y.lanuchTime.substr(0, 10));
      var x_launch = parseISO8601(x.testDate);
      var y_launch = parseISO8601(y.testDate);
      return y_launch - x_launch;
    });

    $("#craftnum").html(ResultSatArr.length);
    loadImagePanel();

    $('#example').dataTable().fnClearTable();
    if (ResultSatArr.length > 0)
      $('#example').dataTable().fnAddData(ResultSatArr, true);
  }


  var loadImagePanel = function () {
    var sats = ResultSatArr;
    var t_lanuch = 0;
    var html = '<li class="line"></li>';
    var needend = false;
    for (var i = 0; i < sats.length; i++) {
      //var launch = parseISO8601(sats[i].lanuchTime.substr(0, 10));
      var launch = parseISO8601(sats[i].testDate);
      var y_launch = launch.getFullYear();
      if (t_lanuch != y_launch) {
        if (needend) {
          html += '</ul></li>';
        }
        html += '<li class="yearList">';
        html += '<span class="db yearTitle">' + y_launch + ' 年</span>';
        html += '<ul class="yearTop">';
        needend = true;
      }
      t_lanuch = y_launch;
      html += '<li class="clearfix">';



      if (sats[i].stage == '测试')
        html += '<a href="/tval/single/index?_id=' + sats[i]._id + '&rbacSatCode=' + sats[i].code + '" target="_blank"><img src="' + sats[i].imgpath + '" alt="" class="satelliteImg fl"></a>';
      else
        html += '<a href="/tval/single/index?_id=' + sats[i]._id + '&rbacSatCode=' + sats[i].code + '" target="_blank"><img src="' + sats[i].imgpath + '" alt="" class="satelliteImg fl gray"></a>';

	  

      if((sats[i].name).length > 10){
	  
          html += '<div class="fl satelliteInfo" style="position: relative;bottom: 8px;">';
          html += '<span class="name" style="position: relative;bottom: 10px;">' + sats[i].name + '</span>';
		  
		  var powertime = Math.random()*1000;
		  
          /*html += '<span class="db mark" style="position: relative;bottom: 10px;">' + sats[i].code_out + '&nbsp;&nbsp;&nbsp;&nbsp;加电时间：'+sats[i].powertime+'</span>';*/
		  
		  
          html += '<span class="db mark" style="position: relative;bottom: 10px;">' + sats[i].code_out + '&nbsp;&nbsp;&nbsp;&nbsp;加电时间：'+powertime.toFixed(1)+'</span>';
		  
          html += '<div class="info" style="position: relative;bottom: 13px;">';
          html += '<span class="db"><span>&#12288;总指挥：</span>' + sats[i].commander + '</span>';
          html += '<span class="db"><span>&#12288;&#12288;总师：</span>' + sats[i].designer + '</span>';
          html += '<span class="db"><span>测试指挥：</span>' + sats[i].test_commander + '</span>';
          html += '</div>';
          html += '</div>';
          html += '</li>';
      }else{
          html += '<div class="fl satelliteInfo">';
          html += '<span class="name">' + sats[i].name + '</span>';
		  
		   var powertime = Math.random()*1000;
		  
          
		  /*
          html += '<span class="db mark">' + sats[i].code_out + '&nbsp;&nbsp;&nbsp;&nbsp;加电时间：'+sats[i].powertime+'</span>';
		  */
		  html += '<span class="db mark">' + sats[i].code_out + '&nbsp;&nbsp;&nbsp;&nbsp;加电时间：'+powertime.toFixed(1)+'</span>';
		  
          html += '<div class="info">';
          html += '<span class="db"><span>&#12288;总指挥：</span>' + sats[i].commander + '</span>';
          html += '<span class="db"><span>&#12288;&#12288;总师：</span>' + sats[i].designer + '</span>';
          html += '<span class="db"><span>测试指挥：</span>' + sats[i].test_commander + '</span>';
          html += '</div>';
          html += '</div>';
          html += '</li>';
      }


    }
    html += '</ul></li>';
    $("#satlist").empty();
    $("#satlist").append(html);
  };

  $(document).ready(function () {
    $('#example').DataTable({
      //ordering: false,
      dom: 'rtip',
      columns: [
        {
          "data": "code_out"
        },
        {
          "data": "name"
        },
        {
          "data": "commander"
        },
        {
          "data": "powertime"
        },
        {
          "data": "code"
        }
      ],
      columnDefs: [{
        render: function (data, type, row) {
          return '<a id="check" class="lookBtn">查看</a>';
        },
        targets: 4
      },
        {
          render: function (data, type, row) {
            return row.commander+'/'+row.designer+'/'+row.test_commander;
          },
          targets: 2
        }
        ,
        {
          render: function (data, type, row) {
            if(row.stage=='在轨')
              return data;
            else
              return '<span style="color:gray">'+data+'</span>'
          },
          targets: 1
        }],
      language: {
        decimal: "",
        emptyTable: "表中数据为空",
        info: "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
        infoEmpty: "显示第 0 至 0 项结果，共 0 项",
        infoFiltered: "(由 _MAX_ 项结果过滤)",
        infoPostFix: "",
        thousands: ",",
        lengthMenu: "显示 _MENU_ 项结果",
        loadingRecords: "载入中...",
        processing: "处理中...",
        search: "搜索:",
        zeroRecords: "没有匹配结果",
        paginate: {
          first: "首页",
          last: "末页",
          next: "＞",
          previous: "＜"
        },
        aria: {
          sortAscending: ": 以升序排列此列",
          sortDescending: ": 以降序排列此列"
        }
      }
    });

    $('#example tbody').on('click', 'a#check', function () {
      var data = $('#example').DataTable().row($(this).parents('tr')).data();
      var hrefv = '/tval/single/index?_id=' + data._id + '&rbacSatCode=' + data.code;
      window.open(hrefv);
    });


    $.ajax({
      cache: true,
      type: "POST",
      url: '/tval/index/getwallsat',
      error: function (request) {
        alert("Connection error");
      },
      success: function (data) {
        SatArray = data.data;
        //console.log(SatArray);
        //debugger;
        $("#factory").select2({placeholder: "限定研制单位", data: getDistinctCloumn(SatArray, "factory"), allowClear: true});
        $('#field').select2({placeholder: "限定卫星领域", data: getDistinctCloumn(SatArray, "field"), allowClear: true});
        $('#applyField').select2({
          placeholder: "限定应用目标",
          data: getDistinctCloumn(SatArray, "applyField"),
          allowClear: true
        });
        $('#orbitType').select2({
          placeholder: "限定轨道形式",
          data: getDistinctCloumn(SatArray, "orbitType"),
          allowClear: true
        });
        $('#platform').select2({
          placeholder: "限定卫星平台",
          data: getDistinctCloumn(SatArray, "platform"),
          allowClear: true
        });
        $('#produce_stage').select2({placeholder: "限定研制阶段", data: getDistinctCloumn(SatArray, "produce_stage"), allowClear: true});
        $("#test_commander").select2({placeholder: "限定测试指挥", data: getDistinctCloumn(SatArray, "test_commander"), allowClear: true});
        $('#commander').select2({placeholder: "限定研制总指挥", data: getDistinctCloumn(SatArray, "commander"), allowClear: true});
        $("#designer").select2({placeholder: "限定研制总师", data: getDistinctCloumn(SatArray, "designer"), allowClear: true});
        $('#size').select2({placeholder: "限定卫星大小", data: getDistinctCloumn(SatArray, "size"), allowClear: true});
        $("#testYear").select2({placeholder: "限定测试年份", data: getDistinctCloumn(SatArray, "testYear"), allowClear: true});//lanuchYear
        $('#powerstyle').select2({placeholder: "限定推进类型", data: getDistinctCloumn(SatArray, "powerstyle"), allowClear: true});
        $("#factory").val(null).trigger("change");
        $("#field").val(null).trigger("change");
        $("#applyField").val(null).trigger("change");
        $("#orbitType").val(null).trigger("change");
        $("#platform").val(null).trigger("change");
        $("#produce_stage").val(null).trigger("change");
        $("#test_commander").val(null).trigger("change");
        $("#commander").val(null).trigger("change");
        $("#designer").val(null).trigger("change");
        $("#size").val(null).trigger("change");
        $("#testYear").val(null).trigger("change");
        $("#powerstyle").val(null).trigger("change");

        querysats();

        $('.condition').on("change", function (e) {
          querysats();
        });

        $("#searchBtn").click(function () {
          querysats();
        });

        $(".trbselect").click(function () {
          if ($(this).attr('id') !== $('.trbselect.current')[0].id) {
            $('.trbselect.current').removeClass('current');
            $(this).addClass('current');
          }
          if ($(this).attr('id') == 'show_image') {
            $("#satlist").css("display", "");
            $("#sattable").css("display", "none");
          } else {
            $("#satlist").css("display", "none");
            $("#sattable").css("display", "");
          }
        });

      }
    });


  });
</script>
</body>
</html>
