<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="space">
    <meta name="keywords" content="space">
    <title>产品综合分析</title>
    <link rel="stylesheet" type="text/css" href="/static/home/css/reset.css">
    <link rel="stylesheet" href="/static/home/css/global.css">
    <link rel="stylesheet" href="/static/home/css/main.css">
    <!--[if IE 8]>
    <link rel="stylesheet" href="/static/home/css/font.css">
    <![endif]-->
    <style type="text/css" media="screen">
        body, html {
            margin: 0;
            padding: 0;
            position: relative;
            font-size: 100%;
        }

        body {
            min-width: 1200px;
            background: #00294d url(/static/home/images/banner_1.png) no-repeat;
            background-position: center 0;
        }
    </style>

    <link href="/static/home/compontents/select2/dist/css/select2.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/static/home/css/myselect2.css">
</head>
<body>
<input type="hidden" id="userimg" value="{{userimgpath}}"/>
<div class="header wrapper">
    <img src="/static/home/images/logo.png" alt="" class="logo">
    <ul class="nav">
        <li class="navItem">
            <a href="/home/rank" target="_blank" class="leaderboard"></a>
        </li>
        <li class="navItem">
            <a href="/home/analysis/satNYr" target="_blank" class="analysis"></a>
        </li>
        <li class="navItem">
            <a href="/home/index/wall" target="_blank" class="displaywall"></a>
        </li>
        <li class="navItem last">
            <a href="#" class="indicatordisplay active"></a>
        </li>
    </ul>
    <div class="user">
        <img src="/static/userimages/foreground.png" class="usericon-wapper">
        <img src="{{userimgpath}}" class="usericon">
        <ul class="dropdownBox">
            <li class="userInfo">
                <span class="db font24">{{userInfo.name}}</span>
                <span class="db font14">当前登录者</span>
            </li>
            <li class="dropdownList js_modify"><a class="color33">修改密码</a></li>
            <li class="dropdownList"><a class="colorR" href="javascript:" onclick="logout()">退出</a></li>
        </ul>
    </div>
</div>

<div class="content wrapper marT60">
    <!--img src="/static/home/images/title_analysis.png" alt="" class="title"-->
    <div class="optionalRangeBox">
        <div class="rangeTitle" style="padding-top: 15px;padding-bottom:15px">
        </div>
        <div class="indicatorAnalysisFilterBox line" style="padding-bottom: 10px;margin-bottom: 13px">
            <ul class="clearfix filterBox w200" style="margin-bottom: 0px">
                <li class="filterList" style="padding-right: 10px">
                    <span class="db font18">选择产品</span>
                </li>
                <li class="filterList mySelectType40165 mySelectType40455">
                    <select class="condition" id="dev_product" style="width: 455px">
                    </select>
                </li>
                <li class="filterList" style="padding-right: 10px">
                    <span class="db font18">分析内容</span>
                </li>
                <li class="filterList mySelectType40165 mySelectType40455" style="padding-right: 0px">
                    <select class="condition" id="content" style="width: 455px">
                    </select>
                </li>
            </ul>
        </div>

        <div id="chart_wrapper" style="float: left">
            <ul class="clearfix filterBox w200" style="margin-top: 10px;margin-bottom: 0px">
                <li class="filterList" style="padding-right: 10px">
                    <span class="input-group-btn">
                        <a id="style_plain" class="stylebtn current">普通</a>
                    </span>
                </li>
                <li class="filterList" style="padding-right: 10px">
                    <span class="input-group-btn">
                        <a id="style_inverted" class="stylebtn">翻转</a>
                    </span>
                </li>
                <li class="filterList" style="padding-right: 10px">
                    <span class="input-group-btn">
                        <a id="style_polar" class="stylebtn">极地图</a>
                    </span>
                </li>
            </ul>
        </div>
        
        <div style="float: right">
            <ul class="clearfix filterBox w200" style="margin-top: 10px;margin-bottom: 0px">
                <li class="filterList" style="padding-right: 10px">
                    <span class="input-group-btn">
                        <a id="trb_all" class="trbselect current">全部</a>
                    </span>
                </li>
                <li class="filterList" style="padding-right: 10px">
                    <span class="input-group-btn">
                        <a id="trb_avg" class="trbselect">平均</a>
                    </span>
                </li>
            </ul>
        </div>


        <!-- 分析报告 -->
        <div class="analysisReportBox">
            <div class="analysisWrapper" style="background-color: transparent;height: inherit">
                <!--div id='chart' class="w100"></div-->
                <div id="chartDiv" class="w100" style="height: 600px"></div>
            </div>
        </div>

        <div class="indicatorAnalysisFilterBox line" style="padding-bottom: 10px;margin-bottom: 13px">
        </div>

        <div>
            <ul class="clearfix filterBox w200" style="margin-bottom: 0px;">
                <li class="filterList" style="padding-right: 10px">
                    <span class="db font18">统计项目</span>
                </li>
                <li class="filterList mySelectType40165 mySelectType40270" style="padding-right: 4px">
                    <select class="condition" id="groupSel_1" style="width: 270px">
                    </select>
                </li>
                <li class="filterList mySelectType40165 mySelectType40270" style="padding-right: 37px">
                    <select class="condition" id="groupSel_2" style="width: 270px">
                    </select>
                    <span class="input-group-btn">
                        <a class="clickbtn" onclick="query()">分析</a>
                    </span>
                </li>
                <li class="filterList" style="padding-right: 10px">
                    <span class="db font18">检索条件</span>
                </li>
                <li class="filterList mySelectType40165" style="padding-right: 0px">
                    <select class="condition" id="fieldSel" style="width: 165px">
                    </select>
                    <span class="input-group-btn">
                        <a class="clickbtn" onclick="addCondition()">添加</a>
                    </span>
                </li>
            </ul>
        </div>
        <div>
            <ul id="queryFields" class="clearfix filterBox w200" style="margin-bottom: 0px;width: 1137px">
            </ul>
        </div>


    </div>
</div>

<div class="pop_bg"></div>
<div class="modify-password-box">
    <form class="modify-form" id="changpwd">
        <span class="form-title">修改密码</span>
        <div class="form-group">
            <input class="form-input" type="password" autocomplete="off" placeholder="请输入新密码" id="new_p" name="new_p"
                   value="">
        </div>
        <div class="form-group">
            <input class="form-input" type="password" autocomplete="off" placeholder="请再次确认新密码" id="new_p2"
                   name="new_p2" value="">
        </div>
        <div class="form-actions">
            <a href="javascript:;" class="form-btn" onclick="chpassword()">确认修改</a>
        </div>
    </form>
</div>

<div class="footer">
    © CASC 2018
</div>

<script src="/static/home/compontents/jquery.min.js" type="text/javascript"></script>
<script src="/static/home/compontents/highcharts/highcharts.js"></script>
<script src="/static/home/compontents/highcharts/highcharts-more.js"></script>
<script src="/static/home/compontents/highcharts/modules/exporting.js"></script>
<script src="/static/home/compontents/highcharts/themes/dark-blue.js"></script>

<script type="text/javascript" src="/static/home/compontents/select2/dist/js/select2.js"></script>
<script type="text/javascript" src="/static/home/js/placeholderSupport.js"></script>
<script type="text/javascript" src="/static/home/js/mylogin.js"></script>
<script type="text/javascript" src="/static/home/js/util.js"></script>
<script type="text/javascript" src="/static/home/js/pdtanalysis.js"></script>
<script type="text/javascript" src="/static/home/js/highchartpdt.js"></script>
<script>
	var TotalArray = [];
  var PdtArray = [];
  var chartData = {};
  var columns = [];

  columns.push({text: '型谱名称', id: 'dev_spectrum'});
  //columns.push({text: '产品名称', id: 'dev_product'});
  columns.push({text: '卫星名称', id: 'sat_name'});
  columns.push({text: '卫星总体', id: 'sat_factory'});
  columns.push({text: '卫星领域', id: 'sat_field'});
  columns.push({text: '卫星平台', id: 'sat_platform'});
  columns.push({text: '卫星大小', id: 'sat_size'});
  columns.push({text: '卫星状态', id: 'sat_stage'});
  columns.push({text: '应用目标', id: 'sat_applyField'});
  columns.push({text: '轨道类型', id: 'sat_orbitType'});
  columns.push({text: '发射年份', id: 'sat_lanuchYear'});
  columns.push({text: '分系统', id: 'sub_standName'});
  //columns.push({text: '单机名称', id: 'dev_name'});
  //columns.push({text: '单机代号', id: 'dev_code'});

  //columns.push({text: '备份方式', id: 'dev_backup'});
  columns.push({text: '产品厂家', id: 'dev_factory'});
  columns.push({text: '是否进口', id: 'dev_origin'});


  function initSel() {
    $('#queryFields').empty();
    removeAll();
    $('#groupSel_1').select2({placeholder: "请选择统计字段一", data: columns, allowClear: true});
    $('#groupSel_2').select2({placeholder: "请选择统计字段二", data: columns, allowClear: true});
    $('#groupSel_2').val(null).trigger('change');
    $('#fieldSel').select2({placeholder: "请选择检索字段", data: columns});
    $('#fieldSel').val(null).trigger('change');
  };

  function initSelect(field, id) {
    $("#" + id).select2({data: getDistinctCloumn(PdtArray, field)});
  }

  var conditionList = [];

  function addCondition() {
    if ($('#fieldSel').select2('data').length > 0) {
      var data = $('#fieldSel').select2('data')[0];
      debugger;
      var id = data.id;
      var name = data.text;

      var formItem = '<li class="filterList"  style="padding-right: 10px" id="label_' + id + '">' +
          '<span class="db font18" style="width:72px">' + name + '</span></li>' +
          '<li class="filterList mySelectType40165" style="padding-right: 38px" id="form_' + id + '">' +
          '<select class="condition" style="width: 165px" id="' + id + '">' +
          '</select>' +
          '<span class="input-group-btn" style="padding-left: 4px">' +
          '<a class="clickbtn" id="btn_' + id + '" >删除' +
          '</a>' +
          '</span>' +
          '</li>';
      //去除空格添加、重复添加
      if (name != '' && jQuery.inArray(id, conditionList) == -1) {
        $('#queryFields').append(formItem);
        $("#btn_" + id).click(function () {
          var thisid = $(this).context.id;
          remove(thisid.substr(4))
        });
        initSelect(id, id);
        conditionList.push(id);
      }
    }
  }


  function query() {
    $('.stylebtn.current').removeClass('current');
    $('#style_plain').addClass('current');
    
    
    var trb_type = $('.trbselect.current')[0].id;
    
    
    
    var cond = {};
    for (i in conditionList) {
      id = conditionList[i];
      if ($('#' + id).select2('data').length > 0)
        cond[id] = $('#' + id).select2('data')[0].text;
    }
    var group = [];
    var group_1 = $('#groupSel_1').select2('data');
    var group_2 = $('#groupSel_2').select2('data');
    if (group_1.length > 0) {
      group.push(group_1[0].id);
    }
    if (group_2.length > 0) {
      if (jQuery.inArray(group_2[0].id, group) == -1)
        group.push(group_2[0].id);
    }
    debugger;
    if (group.length > 0) {
      var ResultPdtArr = selectArr(PdtArray, cond);

      if (group.length == 1) {
      	if(trb_type=='trb_all'){
      		chartData = singleGroupAnalysis(ResultPdtArr, group[0],'trb_count');
      	}else{
      		chartData = singleGroupAnalysis(ResultPdtArr, group[0],'trb_count');
      		var tempchartData = singleGroupAnalysis(ResultPdtArr, group[0]);
      		for (var si = 0; si < chartData.series.length; si++) {
      			for(var sj=0;sj<chartData.series[si].vals.length;sj++){
      				chartData.series[si].vals[sj] = parseFloat((chartData.series[si].vals[sj] / tempchartData.series[si].vals[sj]).toFixed(2));
      			}
      		}	
      	}
      } else {
      	if(trb_type=='trb_all'){
      		chartData = DoubleGroupAnalysis(ResultPdtArr, group,'trb_count');
      	}else{
      		chartData = DoubleGroupAnalysis(ResultPdtArr, group,'trb_count');
      		var tempchartData = DoubleGroupAnalysis(ResultPdtArr, group);
      		for (var si = 0; si < chartData.series.length; si++) {
      			for(var sj=0;sj<chartData.series[si].vals.length;sj++){
      				chartData.series[si].vals[sj] = parseFloat((chartData.series[si].vals[sj] / tempchartData.series[si].vals[sj]).toFixed(2));
      			}
      		}
      	}
      }
      loadChart('故障数量(个)');
    }
  }

  function remove(id) {
    debugger;
    $('#form_' + id).remove();
    $('#label_' + id).remove();
    var pos = jQuery.inArray(id, conditionList);
    conditionList.splice(pos, 1);
  }

  function removeAll() {
    for (var i in conditionList) {
      var id = conditionList[i];
      $('#form_' + id).remove();
      $('#label_' + id).remove();
    }
    conditionList.splice(0, conditionList.length);
  }


  $(document).ready(function () {
    
    $('#content').select2({minimumResultsForSearch: Infinity});
    
    $('#content').on("change", function (e) {
      var href = "/home/analysis/" + $("#content").val();
      if ($("#content").val() !== 'pdtTRb') {
        window.open(href, '_self');
      }
    });
    
     $('#content').val('pdtTRb').trigger('change');

    initSel();

    $.ajax({
      cache: true,
      type: "POST",
      url: '/home/analysis/loadProductData',
      error: function (request) {
        alert("Connection error");
      },
      success: function (data) {
        TotalArray = data.data;
        $('#dev_product').select2({data: getDistinctCloumn(TotalArray, 'dev_product')});
        $('#dev_product').on("change", function (e) {
        	PdtArray = selectArr(TotalArray, {dev_product:$('#dev_product').val()});
        	query();
        	
        	$(".trbselect").click(function () {
          	if($(this).attr('id') !== $('.trbselect.current')[0].id){
            	$('.trbselect.current').removeClass('current');
            	$(this).addClass('current');
            	query();
          	}
        	});
				});
				$("#dev_product").val($('#dev_product').val()).trigger("change");
      }
    });
  });
</script>
</body>
</html>
